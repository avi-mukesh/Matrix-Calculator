{% extends "base.html" %}

{% block content %}

<div class="main" id="mainDiv" />

<script>
mainDiv = document.getElementById("mainDiv");

// Recalculates sizes of top row buttons based on rest of page
function recalculateTopRowButtonSizes() {
	var buttons = [document.getElementById("scalarButton"), document.getElementById("matrixButton"), document.getElementById("operatorButton")];
	
	var i = 0;
	while (i < buttons.length) {
		var button = buttons[i];
		button.style.width = pxToFloat(window.getComputedStyle(topRowButtonDiv)["width"])/topRowButtonCount - 2*pxToFloat(button.style.paddingLeft) - 2*pxToFloat(button.style.borderWidth);// - (window.innerWidth - document.body.clientWidth)/topRowButtonCount;
		i += 1;
	}
	
	var tallestHeight = 0;
	var i = 0;
	while (i < buttons.length) {
		var button = buttons[i];
		currentHeight = pxToFloat(window.getComputedStyle(button)["height"]);
		if (currentHeight > tallestHeight) {
			tallestHeight = currentHeight;
		}
		i += 1;
	}
	
	var i = 0;
	while (i < buttons.length) {
		var button = buttons[i];
		button.style.height = tallestHeight;
		i += 1;
	}
	
}

// Creates a new top row button e.g. add scalar
function addTopRowButton(id, innerHTML, onclick) {
	var button = document.createElement("div");
	button.id = id;
	button.innerHTML = innerHTML;
	button.class = "button";
	
	button.style.borderWidth = 1;
	button.style.borderStyle = "solid";
	button.style.borderColor = "black";
	button.style.cursor = "pointer";
	button.style.textAlign = "center";
	button.style.verticalAlign = "top";
	button.style.display = "inline-block";
	button.style.padding = 0;
	button.style.paddingTop = 0.02*window.innerHeight;
	button.style.paddingBottom = 0.02*window.innerHeight;
	button.onclick = onclick;
	
	topRowButtonCount += 1;
	
	topRowButtonDiv.appendChild(button);
}

// Create container div for top row buttons
topRowButtonDiv = document.createElement("div");
topRowButtonDiv.id = "topRowButtonDiv";
topRowButtonDiv.style.padding = 0;
topRowButtonDiv.style.marginBottom = 0.05 * window.innerHeight;
mainDiv.appendChild(topRowButtonDiv);
 
// Used for calculating widths for the top row buttons
topRowButtonCount = 0;

// Create all buttons for adding new items
addTopRowButton("scalarButton", "Add scalar", addScalar);
addTopRowButton("matrixButton", "Add matrix", addMatrix);
addTopRowButton("operatorButton", "Add operator	", null);

// Caculate the widths that the top row buttons should be
recalculateTopRowButtonSizes();

// Create container div for all items e.g. scalars, matrices and operators
itemDiv = document.createElement("div");
itemDiv.id = "itemDiv";
itemDiv.style.padding = 0;
mainDiv.appendChild(itemDiv);

// Counts increase/decrease for every item added/removed from the equation
matrixCount = 0;
scalarCount = 0;
operatorCount = 0;

// Creates an empty item that can become a scalar, matrix or operator
function createEmptyItem(itemClass, itemCount) {
	var itemWrapper = document.createElement("div");
	itemWrapper.class = itemClass;
	itemWrapper.id = itemCount;
	itemWrapper.style.display = "grid";
	itemWrapper.style.gridTemplateColumns = "repeat(11, 1fr)";
	itemWrapper.style.gridTemplateRows = "repeat(9, 1fr)"; 
	itemWrapper.style.width = "100%";
	itemWrapper.style.height = 0.3 * window.innerHeight;
	itemWrapper.style.background = "#d6d6d6";
	itemWrapper.style.padding = 0;
	itemWrapper.style.marginBottom = 0.05 * window.innerHeight;
	
	var itemSidebar = document.createElement("div");
	itemSidebar.class = "itemSidebar";
	itemSidebar.style.gridColumnStart = 1;
	itemSidebar.style.gridColumnEnd = 3;
	itemSidebar.style.gridRowStart = 1;
	itemSidebar.style.gridRowEnd = 10;
	itemSidebar.style.background = "#cccccc";
	
	var itemName = document.createElement("div");
	itemName.class = "itemName";
	itemName.style.gridColumnStart = 1;
	itemName.style.gridColumnEnd = 3;
	itemName.style.gridRowStart = 1;
	itemName.style.gridRowEnd = 2;
	itemName.style.background = "#aaaaaa";
	itemName.style.padding = 0;
	itemName.style.textAlign = "center";
	itemName.style.fontSize = pxToFloat(itemWrapper.style.height)/14;
	itemName.innerHTML = itemWrapper.class + itemWrapper.id;
	
	var itemMoveUpIcon = document.createElement("img");
	itemMoveUpIcon.class = "itemMoveUpIcon";
	itemMoveUpIcon.src = "static/moveup.png";
	itemMoveUpIcon.style.cursor = "pointer";
	itemMoveUpIcon.style.imageRendering = "pixelated";
	itemMoveUpIcon.style.height = "100%";
	itemMoveUpIcon.style.margin = "0 auto";
	itemMoveUpIcon.style.gridColumnStart = 2;
	itemMoveUpIcon.style.gridColumnEnd = 3;
	itemMoveUpIcon.style.gridRowStart = 4;
	itemMoveUpIcon.style.gridRowEnd = 5;
	itemMoveUpIcon.onclick = moveItemUp;
	
	var itemDeleteIcon = document.createElement("img");
	itemDeleteIcon.class = "itemDeleteIcon";
	itemDeleteIcon.src = "static/delete.png";
	itemDeleteIcon.style.cursor = "pointer";
	itemDeleteIcon.style.imageRendering = "pixelated";
	itemDeleteIcon.style.height = "100%";
	itemDeleteIcon.style.margin = "0 auto";
	itemDeleteIcon.style.gridColumnStart = 2;
	itemDeleteIcon.style.gridColumnEnd = 3;
	itemDeleteIcon.style.gridRowStart = 6;
	itemDeleteIcon.style.gridRowEnd = 7;
	itemDeleteIcon.onclick = deleteItem;
	
	var itemMoveDownIcon = document.createElement("img");
	itemMoveDownIcon.class = "itemMoveDownIcon";
	itemMoveDownIcon.src = "static/movedown.png";
	itemMoveDownIcon.style.cursor = "pointer";
	itemMoveDownIcon.style.imageRendering = "pixelated";
	itemMoveDownIcon.style.height = "100%";
	itemMoveDownIcon.style.margin = "0 auto";
	itemMoveDownIcon.style.gridColumnStart = 2;
	itemMoveDownIcon.style.gridColumnEnd = 3;
	itemMoveDownIcon.style.gridRowStart = 8;
	itemMoveDownIcon.style.gridRowEnd = 9;
	itemMoveDownIcon.onclick = moveItemDown;

	itemWrapper.appendChild(itemSidebar);
	itemWrapper.appendChild(itemName);
	itemWrapper.appendChild(itemMoveUpIcon);
	itemWrapper.appendChild(itemDeleteIcon);
	itemWrapper.appendChild(itemMoveDownIcon);
	itemWrapper.appendChild(itemMoveDownIcon);
	
	return itemWrapper;
}

// Creates a scalar item
function addScalar() {
	scalarCount += 1;
	var scalarWrapper = createEmptyItem("scalar", scalarCount);
	
	var scalarTextbox = document.createElement("input");
	scalarTextbox.class = "scalarTextbox";
	scalarTextbox.style.boxSizing = "border-box";
	scalarTextbox.style.width = "100%";
	scalarTextbox.style.gridColumnStart = 4;
	scalarTextbox.style.gridColumnEnd = 5;
	scalarTextbox.style.gridRowStart = 2;
	scalarTextbox.style.gridRowEnd = 3;
	scalarTextbox.style.textAlign = "center";
	scalarTextbox.type = "text";
	
	scalarWrapper.appendChild(scalarTextbox);
	
	itemDiv.appendChild(scalarWrapper);
	
	recalculateTopRowButtonSizes();
}

// Creates a matrix item
function addMatrix() {
	matrixCount += 1;
	var matrixWrapper = createEmptyItem("matrix", matrixCount);
	
	var r = 0;
	while (r < 7) {
		var c = 0;
		while (c < 7) {
			var matrixElementTextbox = document.createElement("input");
			matrixElementTextbox.class = "matrixElementTextbox";
			matrixElementTextbox.style.boxSizing = "border-box";
			matrixElementTextbox.style.width = "100%";
			matrixElementTextbox.style.textAlign = "center";
			matrixElementTextbox.type = "text";
			
			matrixElementTextbox.style.gridColumnStart = 4+c;
			matrixElementTextbox.style.gridColumnEnd = 5+c;
			matrixElementTextbox.style.gridRowStart = 2+r;
			matrixElementTextbox.style.gridRowEnd = 3+r;
			
			matrixWrapper.appendChild(matrixElementTextbox);
			
			// Hide any rows or elements so only a 2x2 matrix shows
			if (r > 1 || c > 1) {
				matrixWrapper.lastChild.style.visibility = "hidden";
			}
			c += 1;
		}
		r += 1;
	}
	
	matrixWrapper.setAttribute("rows", 2);
	matrixWrapper.setAttribute("columns", 2);
	
	var addMatrixRowIcon = document.createElement("img");
	addMatrixRowIcon.class = "addMatrixRowIcon";
	addMatrixRowIcon.src = "static/add.png";
	addMatrixRowIcon.style.cursor = "pointer";
	addMatrixRowIcon.style.imageRendering = "pixelated";
	addMatrixRowIcon.style.height = "100%";
	addMatrixRowIcon.style.margin = "0 auto";
	addMatrixRowIcon.style.gridColumnStart = 4;
	addMatrixRowIcon.style.gridColumnEnd = 5;
	addMatrixRowIcon.style.gridRowStart = 9;
	addMatrixRowIcon.style.gridRowEnd = 10;
	addMatrixRowIcon.onclick = addMatrixRow;
	
	var removeMatrixRowIcon = document.createElement("img");
	removeMatrixRowIcon.class = "removeMatrixRowIcon";
	removeMatrixRowIcon.src = "static/remove.png";
	removeMatrixRowIcon.style.cursor = "pointer";
	removeMatrixRowIcon.style.imageRendering = "pixelated";
	removeMatrixRowIcon.style.height = "100%";
	removeMatrixRowIcon.style.margin = "0 auto";
	removeMatrixRowIcon.style.gridColumnStart = 5;
	removeMatrixRowIcon.style.gridColumnEnd = 6;
	removeMatrixRowIcon.style.gridRowStart = 9;
	removeMatrixRowIcon.style.gridRowEnd = 10;
	removeMatrixRowIcon.onclick = removeMatrixRow;
	
	var addMatrixColumnIcon = document.createElement("img");
	addMatrixColumnIcon.class = "addMatrixColumnIcon";
	addMatrixColumnIcon.src = "static/add.png";
	addMatrixColumnIcon.style.cursor = "pointer";
	addMatrixColumnIcon.style.imageRendering = "pixelated";
	addMatrixColumnIcon.style.height = "100%";
	addMatrixColumnIcon.style.margin = "0 auto";
	addMatrixColumnIcon.style.gridColumnStart = 11;
	addMatrixColumnIcon.style.gridColumnEnd = 12;
	addMatrixColumnIcon.style.gridRowStart = 2;
	addMatrixColumnIcon.style.gridRowEnd = 3;
	addMatrixColumnIcon.onclick = addMatrixColumn;
	
	var removeMatrixColumnIcon = document.createElement("img");
	removeMatrixColumnIcon.class = "removeMatrixColumnIcon";
	removeMatrixColumnIcon.src = "static/remove.png";
	removeMatrixColumnIcon.style.cursor = "pointer";
	removeMatrixColumnIcon.style.imageRendering = "pixelated";
	removeMatrixColumnIcon.style.height = "100%";
	removeMatrixColumnIcon.style.margin = "0 auto";
	removeMatrixColumnIcon.style.gridColumnStart = 11;
	removeMatrixColumnIcon.style.gridColumnEnd = 12;
	removeMatrixColumnIcon.style.gridRowStart = 3;
	removeMatrixColumnIcon.style.gridRowEnd = 4;
	removeMatrixColumnIcon.onclick = removeMatrixColumn;
	
	matrixWrapper.appendChild(addMatrixRowIcon);
	matrixWrapper.appendChild(removeMatrixRowIcon);
	matrixWrapper.appendChild(addMatrixColumnIcon);
	matrixWrapper.appendChild(removeMatrixColumnIcon);
	itemDiv.appendChild(matrixWrapper);
	
	recalculateTopRowButtonSizes();
}

function addMatrixRow() {
	var matrixWrapper = event["path"][1];
	var rows = parseInt(matrixWrapper.getAttribute("rows"));
	var columns = parseInt(matrixWrapper.getAttribute("columns"));

	if (rows < 7) {
		var c = 0;
		while (c < columns) {
			elementNumber = 7*rows + c + 5
			matrixWrapper.children[elementNumber].style.visibility = "";
			c += 1;
		}
		matrixWrapper.setAttribute("rows", rows+1)
	}
	
	console.log(matrixWrapper.getAttribute("rows"), matrixWrapper.getAttribute("columns"));
}

function removeMatrixRow() {
	var matrixWrapper = event["path"][1];
	var rows = parseInt(matrixWrapper.getAttribute("rows"));
	var columns = parseInt(matrixWrapper.getAttribute("columns"));
	
	if (rows > 1) {
		var c = 0;
		while (c < columns) {
			elementNumber = 7*(rows-1) + c + 5
			matrixWrapper.children[elementNumber].style.visibility = "hidden";
			c += 1;
		}
		matrixWrapper.setAttribute("rows", rows-1)
	}
	
	console.log(matrixWrapper.getAttribute("rows"), matrixWrapper.getAttribute("columns"));
}

function addMatrixColumn() {
	var matrixWrapper = event["path"][1];
	var rows = parseInt(matrixWrapper.getAttribute("rows"));
	var columns = parseInt(matrixWrapper.getAttribute("columns"));
	
	if (columns < 7) {
		var r = 0;
		while (r < rows) {
			elementNumber = 7*r + columns + 5
			matrixWrapper.children[elementNumber].style.visibility = "";
			r += 1;
		}
		matrixWrapper.setAttribute("columns", columns+1)
	}
	
	console.log(matrixWrapper.getAttribute("rows"), matrixWrapper.getAttribute("columns"));
}

function removeMatrixColumn() {
	var matrixWrapper = event["path"][1];
	var rows = parseInt(matrixWrapper.getAttribute("rows"));
	var columns = parseInt(matrixWrapper.getAttribute("columns"));
	
	if (columns > 1) {
		var r = 0;
		while (r < rows) {
			elementNumber = 7*r + (columns-1) + 5
			matrixWrapper.children[elementNumber].style.visibility = "hidden";
			r += 1;
		}
		matrixWrapper.setAttribute("columns", columns-1);
	}
	
	console.log(matrixWrapper.getAttribute("rows"), matrixWrapper.getAttribute("columns"));
}

function deleteItem(event) {
	// Gets parent element of the delete icon that was clicked
	var item = event["path"][1];
	
	// Changes id, name and count so that each item is still in order
	var i = 0;
	while (i < itemDiv.children.length) {
		// Only change item ids of items with the same class
		if (itemDiv.children[i].class == item.class) {
			if (parseInt(itemDiv.children[i].id) > parseInt(item.id)) {
				// Change id
				itemDiv.children[i].id = parseInt(itemDiv.children[i].id) - 1;
				// Change the name that is displayed
				itemDiv.children[i].children[1].innerHTML = itemDiv.children[i].class + itemDiv.children[i].id;
			}
		}
		i += 1;
	}
	
	if (item.class == "scalar") {
		scalarCount -= 1;
	}
	else if (item.class == "matrix") {
		matrixCount -= 1;
	}
	else {
		operatorCount -= 1;
	}
	
	item.parentNode.removeChild(item);
}

function moveItemUp(event) {
	var item = event["path"][0].parentNode;
	var previousItem = item.previousSibling;
	
	if (previousItem != null) {
		var parent = item.parentNode;
		
		parent.removeChild(item);
		parent.insertBefore(item, previousItem);
		
		// Swaps id's back if items are both of the same class (e.g. both scalars)
		if (previousItem.class == item.class) {
			var tempId = item.id;
			item.id = previousItem.id;
			previousItem.id = tempId;

			item.children[1].innerHTML = item.class + item.id;
			previousItem.children[1].innerHTML = previousItem.class + previousItem.id;
		}
	}
}

function moveItemDown(event) {
	var item = event["path"][0].parentNode;
	var nextItem = item.nextSibling;
	
	if (nextItem != null) {
		var parent = item.parentNode;
		
		parent.removeChild(item);
		
		// If removing the item before last, it must be re-inserted as the last item
		// Because it is the item before last, nextItem.nextSibling will be null meaning we have to use parent.appendChild instead of parent.insertBefore
		if (nextItem.nextSibling == null) {
			parent.appendChild(item);
		}
		else {
			parent.insertBefore(item, nextItem.nextSibling);
		}
		
		// Swaps id's back if items are both of the same class (e.g. both scalars)
		if (nextItem.class == item.class) {
			var tempId = item.id;
			item.id = nextItem.id;
			nextItem.id = tempId;

			item.children[1].innerHTML = item.class + item.id;
			nextItem.children[1].innerHTML = nextItem.class + nextItem.id;
		}
	}
}
</script>

{% endblock %}
